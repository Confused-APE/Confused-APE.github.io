---
layout:	post
title:  "Reversing Malware Internals: WannaCry"
date:   2023-05-11 11:11:11 +0200
categories: [Reversing Malware Internals]
tags: [WannaCry, Ransomware, YARA]
---

## Overview

In my early days into malware analysis, I had analyzed WannaCry ransomware but without delving into reverse engineering due to my limited proficiency in that area. But now with couple of months into malware analysis amd armed with new found expertise in reverse engineering, I decided to reverse the WannaCry ransomware to gain deeper understanding of its internals.

WannaCry ransomware (also known as WCry, WannaCrypt or WannaCrypt0r) appeared on May 12, 2017 and quickly propagate over the internet with its worm feature by exploiting vulnerability in Microsoft SMB (MS17-010).

<br>

## Sample Identification

**Sample Source:** [Triage](https://tria.ge/200320-7j5lhpc5fj)

**SHA256:** 24d004a104d4d54034dbcffc2a4b19a11f39008a575aa614ea04703480b1022c

![VirusTotal Result](/images/2023-05-11-Reversing-Malware-Internals-WannaCry/0.png)

<br>

## WannaCry Ransomware Execution Flow


<br>

## Ransom Note

**WannaCry** drops a ransom note named *@Please_Read_Me@.txt in every folder that it encrypts. 

    Q:  What's wrong with my files?
    
    A:  Ooops, your important files are encrypted. It means you will not be able to access them anymore until they are decrypted.
    If you follow our instructions, we guarantee that you can decrypt all your files quickly and safely!
    Let's start decrypting!
    
    Q:  What do I do?
    
    A:  First, you need to pay service fees for the decryption.
    Please send $300 worth of bitcoin to this bitcoin address: 13AM4VW2dhxYgXeQepoHkHSQuy6NgaEb94

    Next, please find an application file named "@WanaDecryptor@.exe". It is the decrypt software.
    Run and follow the instructions! (You may need to disable your antivirus for a while.)
    
    Q:  How can I trust? 
     
    A:  Don't worry about decryption.
    We will decrypt your files surely because nobody will trust us if we cheat users. 
     
    *   If you need our assistance, send a message by clicking <Contact Us> on the decryptor window.
 
<br>

## Reversing WannaCry Ransomware

### Loader (mssecsvc.exe)

#### KillSwitch

The sample 'mssecsvc.exe' was loaded in IDA Pro and was then jumped to its main function.

![killswitch](/images/2023-05-11-Reversing-Malware-Internals-WannaCry/1.png)

The killswitch URL (http://www[.]iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea[.]com) is copied to killswitch variable which is passed as second parameter to InternetOpenUrlA windows API, which will open up that URL.

- If its successful, it will close the handle and simply exit
- If its unsuccessful, it will call service_mode() function

This killswitch capability of WannaCry could be to evade sandbox environment, which normally simulates the URL that the malware is trying to connect. By trying to reach out to a gibberish non-existence domain, the WannaCry will know if it’s running in sandbox environment. If it connects to the kill switch URL, it will simply exit without doing anything.

<br>

#### Service Mode

When killswitch is not reached, it calls service_mode() function, which can be seen below.

![service_mode](/images/2023-05-11-Reversing-Malware-Internals-WannaCry/2.png)

First there is call to GetModuleFileNameA, which retrieve the full path to this sample. Then it checks if the number of parameter is less then 2.

- Since the no parameters will passed during its execution, the condition will be valid and it will execute the initialize() function.

Under the initialize function, there are call to 2 function; service_creator() and dropper()

![initialize](/images/2023-05-11-Reversing-Malware-Internals-WannaCry/3.png)

The service_creator() function can be seen below.

![service_creator](/images/2023-05-11-Reversing-Malware-Internals-WannaCry/4.png)

![rdata](/images/2023-05-11-Reversing-Malware-Internals-WannaCry/5.png)

First it appends ‘-m security’ to the filename and stores under Buffer by calling sprintf.

Then it retrieves handle of service control manager database by calling OpenScManagerA, and using the handle it creates a service by calling CreateServiceA. The parameters passed to CreateServiceA are:

- The second parameter (lpServiceName) is passed with ‘mssecsvc2.0’.
- The third parameter (lpDisplayName) is passed with ‘Microsoft Security Center (2.0) Service’.
- The eighth parameter (lpBinaryPathName) is passed with Buffer. The Buffer stores the filename (full path of binary) with ‘-m security’ parameter.

So it will create a service of its own binary with ‘-m security’ parameter added to it, along with service name ‘mssecsvc2.0’ and display name ‘Microsoft Security Center (2.0) Service’. Here, the WannaCry is masquerading legitimate service name as defense evasion.

If the service is created successfully, it starts the service by calling StartServiceA.

After that, the execution flow will reach dropper() function.

![initialize](/images/2023-05-11-Reversing-Malware-Internals-WannaCry/6.png)

The dropper() function is shown in couple of parts below.

![dropper](/images/2023-05-11-Reversing-Malware-Internals-WannaCry/7.png)

First it retrieves handle to some module. If it successfully retrieve the handle, then using that handle it will dynamically loads functions like CreateProcessA, CreateFileA, WriteFile and CloseHandle from that module by calling GetProcAddress.

After dynamically loading those function, it checks if successful as can be seen below.

![dynamically load API](/images/2023-05-11-Reversing-Malware-Internals-WannaCry/8.png)

Then, it perform some operation with its resource, which is stored under resource section.

First there is call to FindResourceA to locate the resource named 0x727 (R in ASCII). On checking this sample on Resource Hacker, there is a resource named ‘R’ which seem to contain some PE format file. This could be the next stager.

![Resource hacker](/images/2023-05-11-Reversing-Malware-Internals-WannaCry/9.png)

Then there is call to LoadResource which retrieve handle to obtain pointer of first byte of ‘R’ resource. 

Immediately after that, there is call to LockResource, which retrieve pointer to ‘R’ resource in memory. The return value that contain that pointer is stored under lpBuffer, which could be used later when writing to file.

Finally there is call to SizeOfResource which retrieve the size of ‘R’ resource in byte.

After that it creates ‘C:\Windows\tasksche.exe’ and ‘C:\Windows\qeriuwjhrf’ by calling sprintf and save it under Buffer and NewFileName respectively as can be seen below.

![move file](/images/2023-05-11-Reversing-Malware-Internals-WannaCry/10.png)

![rdata](/images/2023-05-11-Reversing-Malware-Internals-WannaCry/11.png)

Then, there is call to MoveFileExA to move Buffer (C:\Windows\tasksche.exe) to NewFileName (C:\Windows\qeriuwjhrf). During first time execution, it will not move any file since ‘tasksche.exe’ currently do not exist.

Immediately after this, there is call to CreateFileA which creates tasksche.exe under C:\Windows directory.  So, only later when it again execute as service with ‘-m security’ parameter passed, it will move the ‘tasksche.exe’ to ‘qeriuwjhrf’ under the Windows directory when calling MoveFileExA.

The file ‘tasksche.exe’ is only created just now. The data under it is written by calling WriteFile as shown below. Notice the second parameter passed to WriteFile is lpBuffer, which contain the pointer to ‘R’ resource in memory which was returned by LockResource function. The next stager is extracted from ‘R’ resource of resource section and then written to ‘tasksche.exe’.

![second stager drop and execute](/images/2023-05-11-Reversing-Malware-Internals-WannaCry/12.png)

Also, there is call to CreateProcessA where second parameter (lpCommandLine) passed is Buffer that store path to tasksche.exe. By calling CreateProcessA, the next stager ‘tasksche.exe’ dropped under C:\Windows directory will be executed.

<br>

#### Worm Mode

Before analyzing second stager, lets get back to service_mode() function, where it checked if number of parameters is less than 2. Once the service is created, the service will execute the sample with ‘-m security’ parameter. 

![worm mode](/images/2023-05-11-Reversing-Malware-Internals-WannaCry/13.png)

Once executed as service, there is call to StartServiceCtrlDispatcherA at the end. The ServiceName passed is ‘mssecsvc2.0’ and the function called is worm_mode().

<br>

### Second Stager (tasksche.exe)



<br>

### Encryptor (kbdlv.dll)



<br>

## MITRE ATT&CK

|  Tactics|Techniques  |
|--|--|
| Initial Access | T0866 Exploitation of Remote Services |
| Persistence | T1543.003 Create or Modify System Process:  Windows Service |
| Defense Evasion | T1222.001 File and Directory Permissions Modification:  Windows File and Directory Permissions Modification |
|  | T1564.001 Hide Artifacts:  Hidden Files and Directories |
|  | T1036.005 Masquerading: Match Legitimate Name or Location |
| Discovery | T1018 Remote System Discovery |
|  | T1120 Peripheral Device Discovery |
|  | T1016 System Network Configuration Discovery |
| Lateral Movement | T1210 Exploitation of Remote Services |
| Command and Control | T1573.002 Encrypted Channel:  Asymmetric Cryptography |
|  | T1090.003 Proxy: Multi-hop Proxy |
| Impact | T1486 Data Encrypted for Impact |
|  | T1490 Inhibit System Recovery |

<br>

## YARA Rule


<br>
