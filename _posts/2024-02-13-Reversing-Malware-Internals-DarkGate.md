---
layout:	post
title:  "Reversing Malware Internals: DarkGate"
date:   2024-02-13 11:11:11 +0200
categories: [Reversing Malware Internals]
tags: [DarkGate]
---

## **Overview**

<br>

## **Technical Analysis**

### **Initial Stager**

#### URL Obfuscation

Typically, PDFs delivered via phishing emails serve as the initial stager for the Darkgate malware. In this particular PDF sample, there was a "Download" button that, when clicked, will open a URL, which seems like a tracking URL from ClickCease as shown below.

![Initial Stager PDF](/images/2024-02-13-Reversing-Malware-Internals-DarkGate/1.png)

Actually, the malicious URL is hidden using a tracking URL from ClickCease. Darkgate abused Ads technologies to make the URL appear legitimate and to bypass security tools that only verify the domain of a URL to assess its malicious nature. Clicking the download button on PDF will redirects the user to a malicious URL, initiating the download of the next stager, an MSI file. 

<br>

### **Second Stager**

The MSI file was downloaded after clicking the Download button on PDF file, which on examination using Orca revealed the presence of two binary files within the MSI: a DLL file (bz.CustomActionDLL) and a CAB file (bz.WrapperSetupProgram) as indicated by their signature.

![MSI File](/images/2024-02-13-Reversing-Malware-Internals-DarkGate/2.png)

Additionally, the CAB file header point out presence of three files under it; CoreFoundation.dll, iTunesHelper.exe and sqlite3.dll as can be seen below.

![Components Files](/images/2024-02-13-Reversing-Malware-Internals-DarkGate/3.png)

Further inspection using Orca indicated that the CustomAction section is configured to execute the DLL file (bz.CustomActionDll).

![CustomAction](/images/2024-02-13-Reversing-Malware-Internals-DarkGate/4.png)

<br>

#### CAB Extraction & Execution by DLL

Since the DLL will be executed first, the DLL file (bz.CustomActionDll) was analyzed using IDA. The analysis revealed that the DLL retrieves the path to the %TEMP% directory (C:\Users\<USER>\AppData\Local\Temp) and appends ‘MW-<<UUID>>’ to this path. It then creates a directory with this name within the %TEMP% directory, as shown below.

![Create Directory under Temp](/images/2024-02-13-Reversing-Malware-Internals-DarkGate/5.png)

The DLL proceeds to extract those three files of the CAB file under the abovementioned directory using ‘expand.exe’ binary. To achieve this, it first retrieves the path to System32 by calling SHGetFolderPathW with the second argument 37, corresponding to the CSIDL_SYSTEM constant (C:\Windows\System32). It then appends ‘EXPAND.EXE’ to construct the full path to the binary. The DLL also appends the parameters ‘-R files.cab -F:* files’ to specify the extraction operation via ‘expand.exe’ binary . The extraction process is executed by calling ShellExecuteExW with the constructed command. 

![Drop and Extract CAB Files under that Directory](/images/2024-02-13-Reversing-Malware-Internals-DarkGate/6.png)

The three files extracted from CAB file can be seen below.

![Extracted Files from CAB](/images/2024-02-13-Reversing-Malware-Internals-DarkGate/7.png)

Following the extraction of the CAB file contents, the DLL utilizes a similar approach to retrieve the path to the ‘icacls.exe’ binary from the C:\Windows\System32 directory. This executable is then run using ShellExecuteExW. By executing the ‘icacls.exe’ binary, the DLL sets the directory integrity level to high, thereby evading detection. This tactic makes it more difficult for security tools operating at a lower integrity level to detect and remove the directory and its contents.

![Set Directory Integrity to High](/images/2024-02-13-Reversing-Malware-Internals-DarkGate/8.png)

Finally, the DLL execute the iTunesHelper.exe by calling ShellExecuteExW as can be seen below, which is one of the content of the CAB file that was previously extracted via ‘expand.exe’.

![Extract KeySCramblerLogon.exe](/images/2024-02-13-Reversing-Malware-Internals-DarkGate/9.png)

<br>

### **Third Stager**

#### DLL SideLoading

The DLL at last executed iTunesHelper.exe as covered in above section. This execution appears to be part of a DLL sideloading technique, where a legitimate executable is used to load and execute a trojanized DLL by hijacking the DLL search order. The DLL search order is shown in image below. 

![DLL Search Order](/images/2024-02-13-Reversing-Malware-Internals-DarkGate/10.png)

From the previously extracted 3 files, iTunesHelper.exe is a legitimate executable. The CoreFoundation.dll is a trojanized DLL that gets loaded by the legitimate iTunesHelper.exe due to the DLL search order hijacking. The file sqlite3.dll appears to be an encrypted binary as can be seen below. The ‘sqlite3.dll’ is likely to be decrypted by the trojanized DLL after sideloading.

![sqlite3.dll](/images/2024-02-13-Reversing-Malware-Internals-DarkGate/11.png)

<br>

#### Decrypting Files from Encryted Dropper

Additionally, there are lots of repeating text ‘VzXLKSZE’ under the sqlite3.dll file as seen above. That string looked like XOR key, where the contents of sqlite3.dll will perform XOR operation with that key likely to output a new PE (executable) file. This is one of obfuscation technique seen in the wild.

To verify above hypothesis, the CoreFoundation.dll was loaded in IDA. It was found that 

