---
layout:	post
title:  "Reversing Malware Internals: DarkGate"
date:   2023-05-09 11:11:11 +0200
categories: [Reversing Malware Internals]
tags: [DarkGate]
---

# **Overview**


<br>

# **Technical Analysis**

## **Initial Stager**

### URL Obfuscation

Typically, PDFs delivered via phishing emails serve as the initial stager for the Darkgate malware. In this particular PDF sample, there is a "Download" button that, when clicked, opens a malicious URL, as shown below.

![Initial Stager PDF](/images/2024-05-09-Reversing-Malware-Internals-DarkGate/1.png)

Clicking the download button on PDF will redirects the user to a malicious URL, initiating the download of the next stager, an MSI file. The URL is obfuscated using a tracking URL from ClickCease in this case, as shown below.

![Url Obfuscation](/images/2024-05-09-Reversing-Malware-Internals-DarkGate/2.png)

Darkgate abuses Ads technologies to make the URL appear legitimate and to bypass security tools that only verify the domain of a URL to assess its malicious nature.

<br>

## **Second Stager**

### CAB Extraction & Execution by DLL

Upon downloading the MSI file from the provided link, an examination using Orca revealed the presence of two binary files within the MSI: a DLL file (bz.CustomActionDLL) and a CAB file (bz.WrapperSetupProgram).

![MSI File](/images/2024-05-09-Reversing-Malware-Internals-DarkGate/3.png)

The CAB file contain three additional key files; KeyScramblerIE.dll, KeyScramblerLogon.exe and test.txt. These files will be analyzed later after understanding how DLL interact with CAB file.

![Components Files](/images/2024-05-09-Reversing-Malware-Internals-DarkGate/4.png)

Further inspection using Orca indicated that the CustomAction section is configured to execute the DLL file (bz.CustomActionDll).

![CustomAction](/images/2024-05-09-Reversing-Malware-Internals-DarkGate/5.png)

<br>

So, the DLL file (bz.CustomActionDll) was analyzed using IDA. The analysis revealed that the DLL retrieves the path to the %TEMP% directory (C:\Users<USER>\AppData\Local\Temp) and appends ‘MW-<UUID>’ to this path. It then creates a directory with this name within the %TEMP% directory, as shown below.

![Create Directory under Temp](/images/2024-05-09-Reversing-Malware-Internals-DarkGate/6.png)

<br>

The DLL proceeds to extract the contents of the CAB file into files directory under the abovementioned directory using ‘expand.exe’ binary. To achieve this, it first retrieves the path to System32 by calling SHGetFolderPathW with the second argument 37, corresponding to the CSIDL_SYSTEM constant (C:\Windows\System32). It then appends ‘EXPAND.EXE’ to construct the full path to the binary. The DLL also appends the parameters ‘-R files.cab -F:* files’ to specify the extraction operation via ‘expand.exe’ binary . The extraction process is executed by calling ShellExecuteExW with the constructed command.

![Drop and Extract CAB Files under that Directory](/images/2024-05-09-Reversing-Malware-Internals-DarkGate/7.png)

<br>

Following the extraction of the CAB file contents, the DLL utilizes a similar approach to retrieve the path to the ‘icacls.exe’ binary from the C:\Windows\System32 directory. This executable is then run using ShellExecuteExW. By executing the ‘icacls.exe’ binary, the DLL sets the directory integrity level to high, thereby evading detection. This tactic makes it more difficult for security tools operating at a lower integrity level to detect and remove the directory and its contents.

![Set Directory Integrity to High](/images/2024-05-09-Reversing-Malware-Internals-DarkGate/8.png)

<br>

Finally, the DLL execute the KeyScramblerLogon.exe by calling ShellExecuteExW as can be seen below, which is one of the content of the CAB file that was previously extracted via ‘expand.exe’.

![Extract KeySCramblerLogon.exe](/images/2024-05-09-Reversing-Malware-Internals-DarkGate/9.png)

<br>

### DLL SideLoading

As previously mentioned, the CAB file contains three files: KeyScramblerIE.dll, KeyScramblerLogon.exe, and test.txt, which are extracted by the DLL.

![Extracted Files from CAB File](/images/2024-05-09-Reversing-Malware-Internals-DarkGate/10.png)

The DLL then executes KeyScramblerLogon.exe. This execution appears to be part of a DLL sideloading technique, where a legitimate executable is used to load and execute a trojanized DLL by hijacking the DLL search order. The DLL search order is shown in image below.

![DLL Search Order](/images/2024-05-09-Reversing-Malware-Internals-DarkGate/11.png)

In this case, KeyScramblerLogon.exe is a legitimate executable. The KeyScramblerIE.dll is a trojanized DLL that gets loaded by the legitimate KeyScramblerLogon.exe due to the DLL search order hijacking. The file ‘test.txt’ appears to be an encrypted binary as can be seen below. The ‘test.txt’ is likely to be decrypted by the trojanized DLL after sideloading.

![test.txt](/images/2024-05-09-Reversing-Malware-Internals-DarkGate/12.png)

<br>

So, KeyScramblerIE.dll was then loaded in IDA for analysis.And when checking the sample, it was found that it implemented anti-analysis technique using combination of many jmp instructions and GetTickCount as can be seen below.

![Anti-analysis](/images/2024-05-09-Reversing-Malware-Internals-DarkGate/13.png)

In between those jmp instructions, there is a function where the DLL reads the contents of ‘test.txt’ as can be seen below.

![Read test.txt](/images/2024-05-09-Reversing-Malware-Internals-DarkGate/14.png)

After reading the content of test.txt, it will perform XOR operation with a key. The key is ‘SdtDZtLn’ which can be seen repeated alot in test.txt and is shown in the image below.

![XOR key](/images/2024-05-09-Reversing-Malware-Internals-DarkGate/15.png)

After performing XOR operation with the key on the content of test.txt, a executable was output as can be seen in the screenshot from CyberChef.

![Decrypting Obfuscated Binary](/images/2024-05-09-Reversing-Malware-Internals-DarkGate/16.png)

<br>

The above de-obfuscated executable was saved and loaded in IDA for analysis.